function startApp(){function ViewModel(){var self=this;$("#view-list").click(function(){$(".list-container").toggle(),$(".title").show(),$(this).text(function(i,text){return"View List"===text?"Hide List":"View List"})}),this.isMobileView=window.innerWidth<600,$(window).resize(function(){this.newViewIsMobileView=window.innerWidth<600,!this.isMobileView&&this.newViewIsMobileView&&($(".list-container").hide(),$("#view-list").text("View List")),this.isMobileView&&!this.newViewIsMobileView&&$(".list-container").show(),this.isMobileView=this.newViewIsMobileView}),this.markers=modelController.getMarkers(),this.placeList=ko.observableArray([]),this.makePlaceList=function(){for(self.placeList.removeAll(),i=0;i<self.markers.length;i++)self.placeList.push(self.markers[i])},this.makePlaceList(),modelController.setIndex(),this.selectPlace=function(){mapView.isNotActiveMarker(),mapView.isActiveMarker(mapView.markers[this.index]),(self.isMobileView||self.newViewIsMobileView)&&($(".list-container").hide(),$("#view-list").text("View List")),mapView.offsetMap(mapView.markers[this.index]);var windowHeight=window.innerHeight,overlayHeight=$("#sidebar").height();self.isMobileView&&($(".infowindow").css("max-height",.7*(windowHeight-overlayHeight)),$(".title").hide())},this.currentPlace=ko.observable(""),this.tabList=ko.observableArray([]);var tabs=modelController.getTabs();for(i=0;i<tabs.length;i++)self.tabList.push(tabs[i]);this.currentTab=ko.observable(""),this.currentTab(tabs[0]),this.tagList=ko.observableArray([]);var tags=modelController.getTags();for(i=0;i<tags.length;i++)self.tagList.push(tags[i]);this.query=ko.observable(""),this.search=function(value){for(self.placeList.removeAll(),mapView.infowindow.close(),i=0;i<self.markers.length;i++)self.markers[i].title.toLowerCase().indexOf(value.toLowerCase())>=0?(self.placeList.push(self.markers[i]),mapView.markers[i].setVisible(!0),map.setCenter(mapView.newtown)):mapView.markers[i].setVisible(!1);$(".nav-item--active").removeClass("nav-item--active")},this.query.subscribe(self.search),this.filterTag=ko.observable(""),this.filter=function(value){if(value){for(self.placeList.removeAll(),mapView.infowindow.close(),i=0;i<self.markers.length;i++)self.markers[i].tags.indexOf(value)>=0?(self.placeList.push(self.markers[i]),mapView.markers[i].setVisible(!0),map.setCenter(mapView.newtown)):mapView.markers[i].setVisible(!1);$(".nav-item--active").removeClass("nav-item--active")}},this.filterTag.subscribe(self.filter),this.resetPlaceList=function(){for(self.makePlaceList(),i=0;i<mapView.markers.length;i++)mapView.markers[i].setVisible(!0);$("#search").val(null),$("#filter").val(null),map.setCenter(mapView.newtown),mapView.infowindow.close(),mapView.isNotActiveMarker()}}var map,tagModel={asian:"Asian",japanese:"Japanese",thai:"Thai",cafe:"Cafe",chinese:"Chinese",yumCha:"Yum Cha",omnivoreFriendly:"Omnivore-friendly",italian:"Italian",pizza:"Pizza",multiCuisine:"Multi-cuisine",vietnamese:"Vietnamese",desserts:"Desserts",fishAndChips:"Fish & Chips"},markerModel={markers:[{title:"Golden Lotus",position:{lat:-33.8984,lng:151.17817},tags:[tagModel.vietnamese,tagModel.asian]},{title:"Gigi's Pizzeria",position:{lat:-33.89925,lng:151.17759},tags:[tagModel.pizza,tagModel.asian]},{title:"Suzy Spoon's Vegetarian Butcher",position:{lat:-33.89261,lng:151.18687},tags:[tagModel.cafe]},{title:"Gelato Blue",position:{lat:-33.89734,lng:151.17945},tags:[tagModel.desserts,tagModel.omnivoreFriendly]},{title:"Bliss & Chips",position:{lat:-33.89492,lng:151.1817},tags:[tagModel.fishAndChips]},{title:"Vina",position:{lat:-33.89976,lng:151.17767},tags:[tagModel.vietnamese,tagModel.asian]},{title:"Lentil As Anything",position:{lat:-33.89966,lng:151.17764},tags:[tagModel.multiCuisine]},{title:"Basil Pizza & Pasta",position:{lat:-33.89343,lng:151.18405},tags:[tagModel.italian,tagModel.pizza,tagModel.omnivoreFriendly]},{title:"Newtown Pies",position:{lat:-33.89633,lng:151.17984},tags:[tagModel.cafe,tagModel.omnivoreFriendly]},{title:"Blossoming Lotus (Green Palace)",position:{lat:-33.89449,lng:151.18281},tags:[tagModel.asian,tagModel.thai]},{title:"Green Gourmet",position:{lat:-33.89312,lng:151.18421},tags:[tagModel.asian,tagModel.chinese,tagModel.yumCha]},{title:"Superfood Sushi",position:{lat:-33.89259,lng:151.18548},tags:[tagModel.asian,tagModel.japanese]}]},tabModel={tabs:[{title:"Search",content:'<input id="search" class="search" placeholder="Search..." type="search" data-bind="value: query, valueUpdate: \'keyup\'" autocomplete="off"><div id="clear-search" class="clear button" data-bind="click: resetPlaceList" title="Clear the search">x</div>'},{title:"Filter",content:'<select id="filter" class="filter" data-bind="options: tagList, optionsCaption: \'Filter by cuisine...\', value: filterTag"></select><div id="clear-filter" class="clear button" data-bind="click: resetPlaceList" title="Clear the selection">x</div>'}]},modelController={init:function(){mapView.init()},getMarkers:function(){function compare(a,b){return a.title<b.title?-1:a.title>b.title?1:0}return markerModel.markers.sort(compare),markerModel.markers},setIndex:function(){for(i=0;i<markerModel.markers.length;i++)markerModel.markers[i].index=i},getHTMLList:function(){return document.getElementsByClassName("nav-item")},getTags:function(){var tags=[];for(var key in tagModel)if(Object.prototype.hasOwnProperty.call(tagModel,key)){var val=tagModel[key];tags.push(val)}return tags.sort(),tags},getTabs:function(){return tabModel.tabs}},mapView={init:function(){this.newtown={lat:-33.8959847,lng:151.1788048},map=new google.maps.Map(document.getElementById("map"),{center:this.newtown,zoom:16});var self=this;this.markers=modelController.getMarkers(),this.infowindow=new google.maps.InfoWindow({maxWidth:300});var markerListener=function(marker){google.maps.event.addListener(marker,"click",function(e){self.offsetMap(this);var that=this;self.isNotActiveMarker(),self.isActiveMarker(that);var htmlLinks=modelController.getHTMLList();$(".nav-item--active").removeClass("nav-item--active"),$(htmlLinks[this.index]).addClass("nav-item--active");var windowHeight=window.innerHeight,overlayHeight=$("#sidebar").height();window.innerWidth<600&&($(".infowindow").css("max-height",.7*(windowHeight-overlayHeight)),$(".title").hide())})};for(i=0;i<this.markers.length;i++)this.markers[i]=new google.maps.Marker({position:this.markers[i].position,title:this.markers[i].title,info:'<div class="infowindow"><h2>'+this.markers[i].title+'</h2><div><div id="yelp"><h3 class="source-title">Yelp</h3></div><div id="google-places"><h3 class="source-title">Google Places</h3></div></div></div>',icon:"img/map-marker.svg",tags:this.markers[i].tags,map:map}),markerListener(this.markers[i]);google.maps.event.addListener(map,"click",function(e){self.infowindow.close(),self.isNotActiveMarker()})},isActiveMarker:function(marker){marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){marker.setAnimation(null)},2140),marker.icon="img/map-marker-active.svg",this.infowindow.setContent(marker.info),this.infowindow.open(map,marker),this.getYelp(marker),this.getGooglePlaces(marker)},isNotActiveMarker:function(){for(j=0;j<this.markers.length;j++)this.markers[j].setAnimation(null),this.markers[j].icon="img/map-marker.svg"},offsetMap:function(marker){var latLng=marker.getPosition(),windowHeight=window.innerHeight,windowWidth=window.innerWidth,overlayWidth=$("#sidebar").width();600>windowWidth?(map.panTo(latLng),map.panBy(0,0-windowHeight)):(map.panTo(latLng),map.panBy(0-overlayWidth+this.infowindow.maxWidth/2,0-windowHeight))},getYelp:function(place){var auth={consumerKey:"GIdnV7AA9LNrjdgxijDWug",consumerSecret:"h8S9YHpC0tuHtpWsnA5HXbapGZk",accessToken:"_TF1GDa2ulcE48qsFoBNefXszmtqmT5A",accessTokenSecret:"0I3ygsXN3MA7X3CXD_TSnwCPEPs",serviceProvider:{signatureMethod:"HMAC-SHA1"}},accessor={consumerSecret:auth.consumerSecret,tokenSecret:auth.accessTokenSecret};parameters=[],parameters.push(["term",place.title]),parameters.push(["location","Sydney"]),parameters.push(["callback","cb"]),parameters.push(["oauth_consumer_key",auth.consumerKey]),parameters.push(["oauth_consumer_secret",auth.consumerSecret]),parameters.push(["oauth_token",auth.accessToken]),parameters.push(["oauth_signature_method","HMAC-SHA1"]);var message={action:"http://api.yelp.com/v2/search",method:"GET",parameters:parameters};OAuth.setTimestampAndNonce(message),OAuth.SignatureMethod.sign(message,accessor);var parameterMap=OAuth.getParameterMap(message.parameters);parameterMap.oauth_signature=OAuth.percentEncode(parameterMap.oauth_signature);var yelpErrorTimeout=setTimeout(function(){$("#yelp").append('<p class="info">Something\'s gone wrong with our Yelp reviews. Please try again later.</p>')},8e3);return $.ajax({url:message.action,data:parameterMap,cache:!0,dataType:"jsonp",jsonpCallback:"cb",success:function(data){var formattedInfo,image=data.businesses[0].image_url,url=data.businesses[0].url,rating=data.businesses[0].rating,ratingImage=data.businesses[0].rating_img_url,reviewCount=data.businesses[0].review_count,reviewSnippet=data.businesses[0].snippet_text;formattedInfo=reviewCount>0?'<div class="info"><img class="info-image" src="'+image+'" alt="Photo from '+place.title+'"><img class="rating" src="'+ratingImage+'" alt="'+rating+' star rating on Yelp"><p class="review-count">out of '+reviewCount+' reviews</p><h4>Top Review:</h4><p class="snippet">'+reviewSnippet+'</p><p class="centered-element-container"><a class="button--source-link" href="'+url+'" target="_blank">Read more</a></p></div><div class="logo-container"><img class="logo" srcset="img/yelp/yelp-logo-xsmall.png 1x, img/yelp/yelp-logo-xsmall@2x.png 2x" src="img/yelp/yelp-logo-xsmall.png" alt="Yelp logo"></div>':'<p class="info">Unfortunately there are no Yelp reviews for this listing. If you\'ve been here, why don\'t you <a href="'+url+'" target="_blank">write one</a>?</p>',clearTimeout(yelpErrorTimeout),$("#yelp").append(formattedInfo)}}),!1},getGooglePlaces:function(place){function callback(results,status){var formattedInfo;status===google.maps.places.PlacesServiceStatus.OK?service.getDetails({placeId:results[0].place_id},function(googlePlace,status){var stars;stars=googlePlace.rating>0&&googlePlace.rating<.5?'<p class="stars">&#9734;&#9734;&#9734;&#9734;&#9734;</p>':googlePlace.rating>=.5&&googlePlace.rating<1.5?'<p class="stars">&#9733;&#9734;&#9734;&#9734;&#9734;</p>':googlePlace.rating>=1.5&&googlePlace.rating<2.5?'<p class="stars">&#9733;&#9733;&#9734;&#9734;&#9734;</p>':googlePlace.rating>=2.5&&googlePlace.rating<3.5?'<p class="stars">&#9733;&#9733;&#9733;&#9734;&#9734;</p>':googlePlace.rating>=3.5&&googlePlace.rating<4.5?'<p class="stars">&#9733;&#9733;&#9733;&#9733;&#9734;</p>':'<p class="stars">&#9733;&#9733;&#9733;&#9733;&#9733;</p>',formattedInfo=googlePlace.user_ratings_total>0?'<div class="info">'+stars+'<p class="review-count">out of '+googlePlace.user_ratings_total+' ratings</p><h4>Top Review:</h4><p class="snippet">'+googlePlace.reviews[0].text+'</p><p class="centered-element-container"><a class="button--source-link" href="'+googlePlace.url+'" target="_blank">Read more</a></p></div><div class="logo-container"><img class="logo" srcset="img/google-places/powered_by_google_on_white.png 1x, img/google-places/powered_by_google_on_white@2x.png 2x" src="img/google-places/powered_by_google_on_white.png" alt="Powered by Google"></div>':'<p class="info">Unfortunately there are no Google Places reviews for this listing. If you\'ve been here, why don\'t you <a href="'+googlePlace.url+'" target="_blank">write one</a>?</p>',$('<p class="address">'+googlePlace.formatted_address+"</p>").insertAfter("h2"),$("#google-places").append(formattedInfo)}):(formattedInfo='<p class="info">Something\'s wrong with Google Places. Please try again later.</p>',$("#google-places").append(formattedInfo))}var service=new google.maps.places.PlacesService(map);service.nearbySearch({location:mapView.newtown,radius:1e3,keyword:place.title},callback)}};modelController.init();var VM=new ViewModel;ko.applyBindings(VM),ko.applyBindings(VM,document.getElementById("search")),ko.applyBindings(VM,document.getElementById("filter")),ko.applyBindings(VM,document.getElementById("clear-search")),ko.applyBindings(VM,document.getElementById("clear-filter"))}